<script>
let quizData = null;
let currentSectionIndex = 0;
let startTime, timerInterval;

fetch('quiz-data.json')
  .then(response => {
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return response.json();
  })
  .then(data => {
    quizData = data;
    if (!quizData || !quizData.sections) throw new Error("Invalid quiz data structure.");
    document.title = `WGU: ${data.title} OA Prep Exam`;
    document.getElementById('quiz-title').innerText = `üìò WGU: ${data.title} OA Prep Exam üìò`;
    document.getElementById('start-button').disabled = false;
  })
  .catch(err => {
    console.error("Error loading quiz data:", err);
    document.getElementById('quiz-title').innerText = "‚ùå Failed to Load Quiz";
    document.getElementById('start-button').disabled = true;
  });

function formatTime(seconds) {
  const m = String(Math.floor(seconds / 60)).padStart(2, '0');
  const s = String(seconds % 60).padStart(2, '0');
  return `${m}:${s}`;
}

function startTimer() {
  startTime = Date.now();
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('timer').innerText = formatTime(elapsed);
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function renderQuizSection(index) {
  const quizContainer = document.getElementById('quiz');
  quizContainer.innerHTML = '';
  const section = quizData.sections[index];
  const sectionDiv = document.createElement('div');
  sectionDiv.className = 'section';
  sectionDiv.innerHTML = `<h2>Section ${index + 1}: ${section.name}</h2>`;
  shuffle(section.questions);
  section.questions.forEach((q, i) => {
    const id = `q-${index}-${i}`;
    const div = document.createElement('div');
    div.className = 'question';
    div.innerHTML = `<p><strong>${q.question}</strong></p>` +
      q.choices.map((c, ci) => `
        <label>
          <input type="radio" name="${id}" value="${ci}" onclick="showFeedback('${id}', ${ci}, ${q.correct.match(/\d+/)[0]-1}, ${JSON.stringify(q.explanation)})" /> ${c}
        </label>`).join('') +
      `<div class="feedback" id="feedback-${id}"></div>`;
    sectionDiv.appendChild(div);
  });
  quizContainer.appendChild(sectionDiv);
  updateProgress();
}

function showFeedback(id, selected, correct, explanation) {
  const fb = document.getElementById(`feedback-${id}`);
  const isCorrect = selected === correct;
  fb.innerHTML = isCorrect ? `‚úÖ Correct!<br>${explanation}` : `‚ùå Incorrect.<br>${explanation}`;
  updateProgress();
}

function updateProgress() {
  const totalEl = document.getElementById('total');
  const scoreEl = document.getElementById('score');
  const percentEl = document.getElementById('percent');
  const fillEl = document.getElementById('progress-fill');
  const feedbacks = document.querySelectorAll('.feedback');
  let total = 0, correct = 0;
  feedbacks.forEach(f => {
    if (f.innerHTML.includes('‚úÖ')) correct++;
    if (f.innerHTML) total++;
  });
  const percent = total ? Math.round((correct / total) * 100) : 0;
  totalEl.textContent = total;
  scoreEl.textContent = correct;
  percentEl.textContent = percent;
  fillEl.style.width = `${percent}%`;
}

function renderReview() {
  stopTimer();
  const review = document.getElementById('review');
  review.innerHTML = '<h2>Final Review</h2>';
  const summary = document.createElement('div');
  summary.innerHTML = `Score: ${document.getElementById('score').innerText} / ${document.getElementById('total').innerText}<br>` +
                      `Time: ${document.getElementById('timer').innerText}`;
  const missed = Array.from(document.querySelectorAll('.feedback'))
    .filter(f => f.innerHTML.includes('‚ùå'))
    .map(f => `<li>${f.parentElement.querySelector('p').innerText}<br>${f.innerHTML}</li>`);
  review.appendChild(summary);
  review.innerHTML += `<h3>Missed Questions</h3><ul>${missed.join('')}</ul>`;
  review.innerHTML += `<div class="summary-actions">
    <button onclick="location.reload()">Retake Exam</button>
    <button onclick="window.print()">Print</button>
    <button onclick="downloadCSV()">Export CSV</button>
  </div>`;
  review.style.display = 'block';
}

function downloadCSV() {
  let csv = 'Question,Result,Explanation\n';
  document.querySelectorAll('.question').forEach(q => {
    const question = q.querySelector('p').innerText.replace(/,/g, '');
    const fb = q.querySelector('.feedback');
    const result = fb.innerHTML.includes('‚úÖ') ? 'Correct' : 'Incorrect';
    const explanation = fb.innerText.split('\n').slice(1).join(' ').replace(/,/g, '');
    csv += `${question},${result},${explanation}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'quiz_results.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

document.getElementById('start-button').addEventListener('click', () => {
  document.getElementById('start-container').style.display = 'none';
  document.getElementById('quiz').style.display = 'block';
  document.getElementById('progress-container').style.display = 'block';
  renderQuizSection(currentSectionIndex);
  startTimer();
});

document.getElementById('prev-button').addEventListener('click', () => {
  if (currentSectionIndex > 0) {
    currentSectionIndex--;
    renderQuizSection(currentSectionIndex);
  }
});

document.getElementById('next-button').addEventListener('click', () => {
  if (currentSectionIndex < quizData.sections.length - 1) {
    currentSectionIndex++;
    renderQuizSection(currentSectionIndex);
  } else {
    document.getElementById('quiz').style.display = 'none';
    renderReview();
  }
});
</script>
